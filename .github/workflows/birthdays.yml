name: 🎂 Daily Birthday Emails

on:
  schedule:
    - cron: '0 12 * * *'   # 09:00 Argentina (UTC-3)
  workflow_dispatch:        # <-- this makes the "Run workflow" button appear
  # Optional: uncomment to run on every push to main while testing
  # push:
  #   branches: [ main ]

permissions:
  contents: read

jobs:
  send-birthdays:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Prepare credentials
        env:
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
          TOKEN_JSON: ${{ secrets.TOKEN_JSON }}
        run: |
          # credentials.json
          test -n "$GOOGLE_CREDENTIALS_JSON" || { echo "❌ Missing secret GOOGLE_CREDENTIALS_JSON"; exit 1; }
          echo "$GOOGLE_CREDENTIALS_JSON" > credentials.json

          # token.json (supports raw JSON or base64)
          test -n "$TOKEN_JSON" || { echo "❌ Missing secret TOKEN_JSON"; exit 1; }
          if echo "$TOKEN_JSON" | grep -q '^{'; then
            echo "$TOKEN_JSON" > token.json
          else
            echo "$TOKEN_JSON" | base64 --decode > token.json || echo "$TOKEN_JSON" > token.json
          fi

      - name: Run birthday script
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          GMAIL_GROUP_ID: ${{ secrets.GMAIL_GROUP_ID }}
          GMAIL_FALLBACK_ID: ${{ secrets.GMAIL_FALLBACK_ID }}
          SHEET_ID: ${{ secrets.SHEET_ID }}
          SHEET_TAB: Log
          CREDENTIALS_PATH: credentials.json
          TOKEN_PATH: token.json
        run: |
          python birthdays_google.py
